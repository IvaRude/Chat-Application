
{% extends 'base.html' %}
{% load static %}
{% block title %}ChatRoom{% endblock title %}

{% block content %}



    <div class="container">
        <div class="sidebar">
            Sidebar
            <div id="sidebar"></div>
        </div>
        <div class="row d-flex justify-content-center">
            <div class="col-6">
                <form>
                    <div class="form-group">
                        
                        <label for="exampleFormControlTextarea1" class="h4 pt-5">
                            <a href="{{ companion.user_info.get_absolute_url }}">{{ companion.username }}</a>
                        </label>
                        <!-- <textarea class="form-control" id="chat-text" rows="10"></textarea><br> -->
                        <div id="chat-text">
                        </div>
                    </div>
                    <div class="form-group">
                        <input class="form-control" id="input" type="text"></br>
                    </div>
                    <input class="btn btn-secondary btn-lg btn-block" id="submit" type="button" value="Send">
                </form>
            </div>
        </div>
    </div>
    <!-- Переводит room_name из views.py в room-name для js и consumers.py-->
    {{ request.user.username|json_script:"user_username" }}
    {{ room_name|json_script:"chat_pk" }}
    <script src="{% static 'reconnecting-websocket.js' %}"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <!-- <script src="{% static 'chat.js' %}"></script> -->
    <script>
        const username = JSON.parse(document.getElementById('user_username').textContent);
        const sidebarSocket = new ReconnectingWebSocket(
            'ws://' +
            window.location.host +
            '/ws/user/' +
            username +
            '/'
        );
        sidebarSocket.onopen = function(e) {
            console.log('Sidebar online');
            console.log('Hello ' + username);
            fetchChats();
        }

        function fetchChats() {
            console.log('fetchChats');
            sidebarSocket.send(JSON.stringify({'command': 'fetch_chats' }));
        }

        sidebarSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            console.log(data)
            if (data['command'] === 'fetch_chats') {
                
                document.querySelector('#sidebar').innerHTML = "";

                for (let i=data['chats'].length - 1; i >= 0; i--) {
                createChatLink(data['chats'][i]);
                }
            } else if (data['command'] === 'new_message'){
                createChat(data['message']);
            }
        };

        function createChatLink(data) {
            var title = data['title'];
            // var chat_pk = data['chat_pk'].toString();
            var last_message = data['last_message'];
            var link = data['link'];

            var br = document.createElement('br');
            var aTag = document.createElement('a');
            aTag.textContent = title + "\n" + last_message;
            aTag.href = link;
            document.querySelector('#sidebar').appendChild(aTag);
            document.querySelector('#sidebar').appendChild(br);
        };
    </script>
<script>
    const user_username = JSON.parse(document.getElementById('user_username').textContent);
    const roomName = JSON.parse(document.getElementById('chat_pk').textContent);
    var page = 1;
    // document.querySelector('#input').onkeyup = function(e) {
    //     if (e.keyCode === 13) {  // enter, return
    //         document.querySelector('#submit').click();
    //     }
    // };

    document.querySelector('#input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#submit').click();
        }
    };

    document.querySelector('#submit').onclick = function (e) {
        const messageInputDom = document.querySelector('#input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'content': message,
            'author': user_username,
            'command': 'new_message',
            // 'command': 'fetch_messages',
            // 'chat_name': roomName,
        }));
        messageInputDom.value = '';
    };
    // Непонятно, как правильно... И так, и так работает
    // const chatSocket = new WebSocket(
    const chatSocket = new ReconnectingWebSocket(
        'ws://' +
        window.location.host +
        '/ws/chat/' +
        roomName +
        '/'
    );

    chatSocket.onopen = function(e) {
        
        fetchMessages(page);
    }

    function fetchMessages(page) {
        chatSocket.send(JSON.stringify({'command': 'fetch_messages',
                                        'page': page }));
    }

    // chatSocket.onmessage = function (e) {
    //     const data = JSON.parse(e.data);
    //     console.log(data)
    //     document.querySelector('#chat-text').value += (data.username + ': ' + data.message + '\n')
    // }   

    chatSocket.onmessage = function(e) {
    var data = JSON.parse(e.data);
    console.log(data)
    if (data['command'] === 'fetch_messages') {
        for (let i=0; i < data['messages'].length; i++) {
        createMessage(data['messages'][i]);
        }
    } else if (data['command'] === 'new_message'){
        createMessage(data['message']);
        // Обновляет sidebar только у тех кто сейчас смотрит в этот диалог
        // fetchChats();
    }

    function createMessage(data) {
        // console.log(data)
        var author = data['author'];
        var pTag = document.createElement('p');
        pTag.textContent = author + ': ' + data.content;
        document.querySelector('#chat-text').prepend(pTag);
    }
    };


    var chat = $('#chat-text');
    $(window).scroll(function()
        {
        if ($(this).scrollTop() == 0)
            {
                page += 1;
                fetchMessages(page);
                var h = $(chat).children().eq(0).height();
                $(window).scrollTop(h);
            }
        });
</script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous">
    </script>

<!-- <div class="div1"> -->
    <div class="div2 block" style="height: 500px;"></div>
<!-- </div> -->
<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript">
    // var div1 = $('.div1');
    // var div2 = $('.div2');
    // var chat = $('#chat-text');
    // var height = 150;
    // $(window).scroll(function()
    //     {
    //     if ($(this).scrollTop() == 0)
    //         {
    //             page += 1;
    //             fetchMessages(page);
    //         // $(chat).prepend('<div class="block" style="height: ' + height + 'px;">123</div>');
    //         // height += 20;
    //         // if (height > 300)
    //         //     height = 100;
    //         var h = $(chat).children().eq(0).height();
    //         $(window).scrollTop(h);
    //         }

    //     });
</script>
{% endblock content %}

<!-- {% block domready %}
  var page = 1;
  var empty_page = false;
  var block_request = false;

  $(window).scroll(function() {
    var margin = $(document).height() - $(window).height() - 200;
    if  ($(window).scrollDown() > margin && empty_page == false && block_request == false) {
     block_request = true;
      page += 1;
      $.get('?page=' + page, function(data) {
       if(data == '') {
          empty_page = true;
        }
        else {
          block_request = false;
          $('#chat-text').append(data);
        }
      });
    }
  });
{% endblock %} -->
